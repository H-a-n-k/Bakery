@model List<Bakery.Models.sp_ds_gioHang_Result>

@{
	ViewBag.Title = "Index";
}

@section Styles {
	<link href="~/Content/styles/giohang.css" rel="stylesheet" type="text/css" />
}

<div class="cart-page">
	<div class="m-container">
		<div class="cart">
			<div class="row header">
				<div class="col-2"></div>
				<div class="col-4">Sản phẩm</div>
				<div class="col-2">Giá</div>
				<div class="col-2">Số lượng</div>
				<div class="col-2">Tổng</div>
			</div>

			@for (int i = 0; i < Model.Count(); i++)
			{
				double price = Model[i].GiaSP;
				if (Model[i].TiLeKM.HasValue) { price = price * (1 - Model[i].TiLeKM.Value); }
				<div class="row item" data-ind="@i">
					<div class="col-2">
						<div class="img-wrapper">
							<img src="@Model[i].img" alt="">
						</div>
					</div>
					<div class="col-4">@Model[i].TenSP</div>
					<div class="col-2 price" data-val="@price">@string.Format("{0:N0}", price)đ</div>
					<div class="col-2">
						<input type="number" class="quantity" value="@Model[i].SoLuong" min="0" max="@Model[i].SoluongSP"
							   onkeydown="onQuantityKeydown(event)" onchange="onCartQuantityChange(event, @Model[i].MaSP); calcPrice();" />
					</div>
					<div class="col-2 sum">

					</div>
				</div>
			}
		</div>

		<div class="dialog-wrapper hidden">
			<div class="dialog-content">
				<form action="giohangs/checkout" method="post" id="frm-checkout">
					<h3>Xác nhận thanh toán</h3>
					<div class="amount">Số tiền: <span id="total-2">0</span></div>
					<label>Địa chỉ: </label>
					<input type="text" placeholder="Nhập địa chỉ" name="addr" value="" required />
					<input type="submit" value="Xác nhận" />
				</form>
			</div>
		</div>

		<div class="checkout">
			<div class="total">
				Tổng tiền: <span class="value" id="total"></span>
			</div>

			<button class="pay" onclick="showCheckoutConfirmDialog()">Thanh toán</button>
		</div>

	</div>
</div>

@section scripts {
	<script>

		$(document).ready(() => {
			calcPrice();
		})

		function numberWithCommas(x) {
			return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		}

		function calcPrice() {
			const items = $('.row.item');
			let total = 0;
			for (let i = 0; i < items.length; i++) {
				let price = $(`.item[data-ind='${i}'] .price`).data('val');
				let quant = $(`.item[data-ind='${i}'] .quantity`).val();
				console.log(items);

				total += price * quant;
				$(`.item[data-ind='${i}'] .sum`).html(numberWithCommas(price * quant) + 'đ');
			}

			$('#total').html(numberWithCommas(total)+ 'đ');
		}

		function removeItem(masp) {
			$.post('giohangs/RemoveItem', { masp }, () => {
				window.location.reload();
			});
		}

		function showCheckoutConfirmDialog() {
			$('.dialog-wrapper').removeClass('hidden')
			$('#total-2').html($('#total').html());
		}
	</script>
}